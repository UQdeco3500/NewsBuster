<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="css/phone.css">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="leaflet/leaflet.css" />
    <link rel="stylesheet" href="css/live.css"/>
    <script src="leaflet/leaflet.js"></script>
    <script src="link.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <title>Mobile & Social</title>
</head>
<body class="background">
    <!-- <div class="iphone-x">
        <div class="iphone-mask" id="detect-phone-mask"></div> -->

        <div id="overlay">
        </div>

        <div class= 'message' id="no-similarity-message">
            <img class="live-close" src="img/icon/close.png">
            <p id="error-line1">Please try again!</p>
            <p id="error-line2">The artwork in your image could not be detected.</p>
            <img id="error-icon" src="img/live/error.png">
            <p id="error-back-button">Back</p>
        </div>

        <div class="message" id="success-message">
            <img class="live-close" src="img/icon/close.png">
            <p id="success-line1">Thank you for sharing!</p>
            <p id="success-line2">Your shared artwork is highlighted in pink.</p>
            <div></div>
            <p id="success-view-button">View</p>
        </div>

        <div class="message" id="end-message">
            <img class="live-close" src="img/icon/close.png">
            <p id="end-line1">Session ended</p>
            <p id="end-line2">Here is a summary of the session you attended.</p>
            <p id="end-line3">This session's winner:</p>
            <img id="winning-img">
            <p id="end-line4">Total attendees: </p>
            <p id="end-line5">Total photos posted: </p>
            <p id="end-done-button">Done</p>
        </div>

        <div id="camera-div">
            <div id="camera-roll-button"></div>
            <div id="take-photo-button"></div>
            <img id="camera-screen-img" src="img/live/camera-screen.png">
        </div>

        <div id="camera-roll-div">
            <div id="camera-roll-cancel"></div>
            <div class="photo-select" id="camera-roll-art-1"></div>
            <div class="photo-select" id="camera-roll-art-2"></div>
            <div class="photo-select" id="camera-roll-art-3"></div>
            <div class="photo-select" id="camera-roll-art-4"></div>
            <div class="photo-select" id="camera-roll-art-5"></div>
            <div class="photo-select" id="camera-roll-art-no-similarity"></div>
            <img id="camera-screen-img" src="img/live/camera-roll-screen.png">
        </div>

        <div class="live-container">
            <img id="go-back-icon" src="img/live/go-back.png">
            <div class="live-bar">
                <div id="user-count">
                    <img id="live-icon" src="img/live/live.png">
                    <div>
                    <p id="user-count-value">9</p>
                    <img id="users-icon" src="img/live/users.png">
                    </div>
                </div>
            </div>
            <p id="desc">Share your favourite artwork!</p>
            <div class="live-img-container">
                <label id="upload-button" for="upload-img">
                    <!-- <input type="file" name="upload-img" id="upload-img" style="display:none;"/> -->
                    <img id='camera-icon' src="img/live/camera-plus.png">
                </label>
                <div class="user-count-container"><img id="art1-live" class="live-img" src=img/live/gallery/art1.jpeg><div class="img-user-count"><p id="art1-live-count">5</p><img src="img/live/users.png"></div></div>
                <div class="user-count-container"><img id="art2-live" class="live-img" src=img/live/gallery/art2.jpeg><div class="img-user-count"><p id="art2-live-count">2</p><img src="img/live/users.png"></div></div>
                <div class="user-count-container"><img id="art3-live" class="live-img" src=img/live/gallery/art3.jpeg><div class="img-user-count"><p id="art3-live-count">1</p><img src="img/live/users.png"></div></div>
            </div>
        </div>
        <div id='end-button'><p>End event</p></div>
        <!-- navigation bar -->
        <div class="icons">
            <div class= "icon icon-l">
                <img class= "non_hover"  src="img/icon/Gallery.png">                
                <img href="map.html" class= "hover_img hover_img-l" src="img/icon/Gallery (hovered colour).png">
            </div>
            <div class= "icon icon-l-m">
                <img src="img/icon/Home.png">
                <img class= "hover_img hover_img-m" src="img/icon/Home (hovered colour).png">
            </div>
            <div class= "icon icon-r-m">
                <img src="img/icon/Image upload.png">
                <img class= "hover_img hover_img-r" src="img/icon/Image upload (hovered colour).png">
            </div>
            <div class= "icon icon-r">
                <img src="img/icon/profile page.png">
                <img class= "hover_img hover_img-r" src="img/icon/profile page (hovered colour).png">
            </div>
        </div>
    </div>

</body>
<script>
    var galleryImgs = [
        {
            "path": "art1.jpeg",
            "user-count": 5,
            "id": "art1-live",
            "width": 15
        },
        {
            "path": "art2.jpeg",
            "user-count": 2,
            "id": "art2-live",
            "width": 12
        },
        {
            "path": "art3.jpeg",
            "user-count": 1,
            "id": "art3-live",
            "width": 11
        },
        {
            "path": "art4.jpeg",
            "user-count": 0,
            "id": "art4-live",
            "width": 10
        },
        {
            "path": "art5.jpeg",
            "user-count": 0,
            "id": "art5-live",
            "width": 10
        }
    ]

    function getRandomIndex(min, max) {
        return Math.floor(Math.random() * (max - min) + min); // The maximum is exclusive and the minimum is inclusive
    }
    
    const imgInput = document.getElementById("upload-img");
    var interactionInterval;
    var viewers;

    document.getElementById('camera-roll-button').addEventListener('click', function(){
        document.getElementById('camera-roll-div').style.display = "block";
        document.getElementById('camera-div').style.display = "none";
    })
    document.getElementById('camera-roll-cancel').addEventListener('click', function(){
        document.getElementById('camera-roll-div').style.display = "none";
        document.getElementById('camera-div').style.display = "block";
    })

    document.getElementById('take-photo-button').addEventListener('click', function(){
        document.getElementById('camera-screen-img').src = "img/live/camera-screen.png";
        setTimeout(function(){
            document.getElementById('camera-div').style.display = "none";
            startSimulation('art1.jpeg');
        }, 100);
    })

    document.getElementById('take-photo-button').addEventListener('mousedown', function(){
        document.getElementById('camera-screen-img').src = "img/live/camera-screen-clicked.png";
    })

    document.getElementById('camera-icon').addEventListener('click', function(){
        document.getElementById('camera-div').style.display = "block";
    })

    document.getElementById("camera-roll-art-1").addEventListener('click', function(){
        setTimeout(function(){
            document.getElementById('camera-roll-div').style.display = "none";
            startSimulation('art1.jpeg');
        }, 100);
    })
    document.getElementById("camera-roll-art-2").addEventListener('click', function(){
        setTimeout(function(){
            document.getElementById('camera-roll-div').style.display = "none";
            startSimulation('art2.jpeg');
        }, 100);
    })
    document.getElementById("camera-roll-art-3").addEventListener('click', function(){
        setTimeout(function(){
            document.getElementById('camera-roll-div').style.display = "none";
            startSimulation('art3.jpeg');
        }, 100);
    })
    document.getElementById("camera-roll-art-4").addEventListener('click', function(){
        setTimeout(function(){
            document.getElementById('camera-roll-div').style.display = "none";
            startSimulation('art4.jpeg');
        }, 100);
    })
    document.getElementById("camera-roll-art-5").addEventListener('click', function(){
        setTimeout(function(){
            document.getElementById('camera-roll-div').style.display = "none";
            startSimulation('art5.jpeg');
        }, 100);
    })
    document.getElementById("camera-roll-art-no-similarity").addEventListener('click', function(){
        setTimeout(function(){
            document.getElementById('camera-roll-div').style.display = "none";
            startSimulation('no-similarity.jpeg');
        }, 100);
    })

    function startSimulation(chosenArt){
        var detectedArtwork = galleryImgs.filter(image => image["path"] == chosenArt)[0];
        if (detectedArtwork === undefined){
                // Display pop-up to show no similarity
                document.getElementById('overlay').style.display = "block";
                document.getElementById("no-similarity-message").style.display = "block"
            }
            else{
                //Diplay pop-up to communicate success
                document.getElementById('overlay').style.display = "block";
                document.getElementById("success-message").style.display = "block";
                document.getElementById('end-button').style.display = "block";

                document.getElementById("upload-button").style.display = "none"; // Remove upload button if the image is received successfully
                console.log("image detected");
                detectedArtwork["user-count"]+=1;
                if (document.getElementById(detectedArtwork["id"])){
                    // Increase width of the user uploaded photo
                    if (detectedArtwork["width"]<30){
                        detectedArtwork["width"]+=1;
                    }
                    document.getElementById(detectedArtwork['id']).style.width=`${detectedArtwork["width"]}vh`;
                    // Set class name to change stlying of the image border
                    document.getElementById(detectedArtwork["id"]).classList.add("current-user");
                    // Update the user counter
                    document.getElementById(`${detectedArtwork["id"]}-count`).innerHTML = detectedArtwork["user-count"];
                    // Show pop-up
                }
                else{
                    document.getElementsByClassName("live-img-container")[0].innerHTML+=`<div class="user-count-container"><img id=${detectedArtwork["id"]} class="live-img current-user" src=img/live/gallery/${detectedArtwork["path"]}><div class="img-user-count"><p id=${detectedArtwork['id']}-count>${detectedArtwork['user-count']}</p><img src="img/live/users.png"></div></div>`;
                    // Show pop-up
                };

                interactionInterval = setInterval(function(){
                var artwork = galleryImgs[getRandomIndex(0,5)];
                var addValue = getRandomIndex(1,3);
                artwork["user-count"]+=addValue;
                if (document.getElementById(artwork["id"])){
                    // Increase width of the user uploaded photo
                    if (artwork["width"]<30){
                        artwork["width"]+=addValue;
                    }
                    document.getElementById(artwork['id']).style.width=`${artwork["width"]}vh`;
                    // Update the user counter
                    document.getElementById(`${artwork["id"]}-count`).innerHTML = artwork["user-count"];
                    // Show pop-up
                }
                else{
                    document.getElementsByClassName("live-img-container")[0].innerHTML+=`<div class="user-count-container"><img id=${artwork["id"]} class="live-img" src=img/live/gallery/${artwork["path"]}><div class="img-user-count"><p id=${artwork['id']}-count>${artwork['user-count']}</p><img src="img/live/users.png"></div></div>`;
                    // Show pop-up
                };
                }, 3000);
            }
    }

    // imgInput.addEventListener('change', () => {
    //     var parts = imgInput.value.split("\\");
    //     var result = parts[parts.length - 1];
    //     let reader = new FileReader();
    //     reader.readAsDataURL(imgInput.files[0]);
    //     reader.addEventListener("load", () => {
    //         var detectedArtwork = galleryImgs.filter(image => image["path"] == result)[0];
    //         if (detectedArtwork === undefined){
    //             // Display pop-up to show no similarity
    //             document.getElementById('overlay').style.display = "block";
    //             document.getElementById("no-similarity-message").style.display = "block"
    //         }
    //         else{
    //             //Diplay pop-up to communicate success
    //             document.getElementById('overlay').style.display = "block";
    //             document.getElementById("success-message").style.display = "block";

    //             document.getElementById("upload-button").style.display = "none"; // Remove upload button if the image is received successfully
    //             console.log("image detected");
    //             detectedArtwork["user-count"]+=1;
    //             if (document.getElementById(detectedArtwork["id"])){
    //                 // Increase width of the user uploaded photo
    //                 if (detectedArtwork["width"]<30){
    //                     detectedArtwork["width"]+=1;
    //                 }
    //                 document.getElementById(detectedArtwork['id']).style.width=`${detectedArtwork["width"]}vh`;
    //                 // Set class name to change stlying of the image border
    //                 document.getElementById(detectedArtwork["id"]).classList.add("current-user");
    //                 // Update the user counter
    //                 document.getElementById(`${detectedArtwork["id"]}-count`).innerHTML = detectedArtwork["user-count"];
    //                 // Show pop-up
    //             }
    //             else{
    //                 document.getElementsByClassName("live-img-container")[0].innerHTML+=`<div class="user-count-container"><img id=${detectedArtwork["id"]} class="live-img current-user" src=img/live/gallery/${detectedArtwork["path"]}><div class="img-user-count"><p id=${detectedArtwork['id']}-count>${detectedArtwork['user-count']}</p><img src="img/live/users.png"></div></div>`;
    //                 // Show pop-up
    //             };

    //             interactionInterval = setInterval(function(){
    //             var artwork = galleryImgs[getRandomIndex(0,5)];
    //             var addValue = getRandomIndex(1,3);
    //             artwork["user-count"]+=addValue;
    //             if (document.getElementById(artwork["id"])){
    //                 // Increase width of the user uploaded photo
    //                 if (artwork["width"]<30){
    //                     artwork["width"]+=addValue;
    //                 }
    //                 document.getElementById(artwork['id']).style.width=`${artwork["width"]}vh`;
    //                 // Update the user counter
    //                 document.getElementById(`${artwork["id"]}-count`).innerHTML = artwork["user-count"];
    //                 // Show pop-up
    //             }
    //             else{
    //                 document.getElementsByClassName("live-img-container")[0].innerHTML+=`<div class="user-count-container"><img id=${artwork["id"]} class="live-img" src=img/live/gallery/${artwork["path"]}><div class="img-user-count"><p id=${artwork['id']}-count>${artwork['user-count']}</p><img src="img/live/users.png"></div></div>`;
    //                 // Show pop-up
    //             };
    //             }, 3000);
    //         }
    //     });
    // })

    var countChange = setInterval(function(){
        var randomChange = getRandomIndex(0,10);
        viewers =parseInt(document.getElementById("user-count-value").innerHTML) + randomChange;
        document.getElementById("user-count-value").innerHTML = viewers;
    }, 5000);

    document.getElementById('overlay').addEventListener('click', function(){
        document.getElementById('overlay').style.display = "none";
        Array.from(document.getElementsByClassName('message')).forEach(div => {
            div.style.display = 'none';
        });
    })

    document.getElementById('success-view-button').addEventListener('click', function(){
        document.getElementById('overlay').style.display = "none";
        document.getElementById('success-message').style.display = "none";
    })

    document.getElementById('end-done-button').addEventListener('click', function(){
        document.getElementById('overlay').style.display = "none";
        document.getElementById('end-message').style.display = "none";
    })

    document.getElementById('error-back-button').addEventListener('click', function(){
        document.getElementById('overlay').style.display = "none";
        document.getElementById('no-similarity-message').style.display = "none";
    })

    document.getElementById('end-button').addEventListener('click', function(){
        clearInterval(interactionInterval);
        clearInterval(countChange);

        // Map the user counts of each artwork
        var countArray = galleryImgs.map((artwork)=> artwork['user-count']);
        var winningCount = Math.max(...countArray);
        var winningArtwork = galleryImgs.filter(artwork => artwork["user-count"] === winningCount)[0];
        
        document.getElementById("winning-img").src = `img/live/gallery/${winningArtwork["path"]}`;
        document.getElementById("end-line4").innerHTML += viewers;
        document.getElementById("end-line5").innerHTML += countArray.reduce((num1, num2) => num1 + num2, 0)

        //Diplay pop-up to signal end of session

        document.getElementById('overlay').style.display = "block";
        document.getElementById("end-message").style.display = "block";
    })

    document.getElementsByClassName('hover_img-l')[0].addEventListener('click', function() {
        window.location.href = 'map.html';
    });

    Array.from(document.getElementsByClassName('live-close')).forEach(closeButton => {
            closeButton.addEventListener('click', function(){
                document.getElementById('overlay').style.display = "none";
                Array.from(document.getElementsByClassName('message')).forEach(div => {
                    div.style.display = 'none';
                });
            })
        });

    document.getElementsByClassName('hover_img-r')[0].addEventListener('click', function() {
        window.location.href = 'detect.html';
    });

    document.getElementsByClassName('hover_img-m')[0].addEventListener('click', function() {
        window.location.href = 'home.html';
    });
</script>
</html>